@model WebQuanLySinhVien.Models.ViewModels.ThongKe.SL_SinhVienNganh
@using System.Text.Json
@{
    ViewData["Title"] = "Thống kê";
}
<div class="col-md-12">
	<div class="card">
		<div class="header">
			<label>Chọn mã ngành</label>
		</div>
			
		<div class="content">
			<select asp-for="SelectedID" class="form-control" id="userselect" onchange="redirectToThongke()">
				<option value="">-- chọn mã ngành --</option>
				@foreach (var id in Model.DanhSachIDNganh)
				{
					<option value="@id" selected="@(Model.SelectedID == id ? "selected" : null)">
						@id
					</option>
				}
			</select>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-4">
		<div class="card">
			<div class="header">
				<h4 class="title">Thống kê số lượng sinh viên</h4>
				<p class="category">Số lượng sinh viên của từng học phần theo ngành</p>
				
			</div>
			<div class="content">
				<div id="chartPreferences" class="ct-chart ct-perfect-fourth"></div>

				<div class="footer">
					<div id="legend" class="legend"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-md-8">
		<div class="card">
			<div class="header">
				<h4 class="title">Thống kê số điểm sinh viên</h4>
				<p class="category">Số điểm của sinh viên theo từng học phần trong ngành</p>
			</div>
			<div class="content">
				<div id="chartSales" class="ct-chart "></div>
				<div class="footer">
					<div id="legend2" class="legend"></div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="header">
				<h4 class="title">Thống kê so sánh số điểm sinh viên</h4>
				<p class="category">So sánh số lượng điểm trên và dưới trung bình của từng học phần </p>
			</div>
			<div class="content">
				<div id="chartActivity" class="ct-chart "></div>
				<div class="footer">
					<div id="legend3" class="legend">
						<i class="fa fa-circle text-info"></i> Điểm trên trung bình
						<i class="fa fa-circle text-danger"></i> Điểm dưới trung bình
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="header">
				<h4 class="title">Thống kê số điểm sinh viên</h4>
				<p class="category">Thống kê số điểm sinh viên theo từng học phần </p>
				<select asp-for="SelectedSVID" class="form-control" id="userselect2" onchange="redirectToThongke()">
					<option value="">-- chọn mã sinh viên --</option>
					@foreach (var id in Model.DanhSachSVTheoNganh)
					{
						<option value="@id" selected="@(Model.SelectedSVID == id ? "selected" : null)">
							@id
						</option>
					}
				</select>
			</div>
			<div class="content">
				<div id="chartViews" class="ct-chart "></div>
				<div class="footer">
					<div id="legend4" class="legend">
						
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- javascript -->
<script>
	window.onload = function(){
		//BIỂU ĐỒ TRÒN

		var _model = @Html.Raw(JsonSerializer.Serialize(Model)); console.log(_model);

		var dataList = _model.DanhSachSoLuongSinhVien;
		

		if (!Array.isArray(dataList)) {
			dataList = Object.values(dataList); // Chuyển đổi object thành mảng
		}
		

		var total = dataList.reduce(function(sum, item) {
			return sum + item.SoLuong;
		}, 0);
		console.log(dataList);

		// Chuẩn hóa dữ liệu để tổng bằng 100
		var normalizedData = dataList.map(function(item) {
			return {
				name: item.MaHP,
				value: (item.SoLuong / total) * 100
			};
		});

		//Tạo nhãn và dữ liệu
		var labels = normalizedData.map(function(item) {
			return item.value.toFixed(2) + '%';
		});



		var series = new Array() ;
		normalizedData.map(function(item){
			series.push(item.value);
		});

		var dataPreferences = {
			series: [
				[25, 30, 20, 25]
			]
		};

		var optionsPreferences = {
			donut: true,
			donutWidth: 40,
			startAngle: 0,
			total: 100,
			showLabel: false,
			axisX: {
				showGrid: false
			}
		};

		//Chartist.Pie('#chartPreferences', dataPreferences, optionsPreferences);

		var chart = new	Chartist.Pie('#chartPreferences', {
			labels: labels,
			series: series
		});

		chart.on('created', function() {
			var legendContainer = document.getElementById('legend');

			if (!legendContainer) {
				console.error("Lỗi: Không tìm thấy phần tử #legend");
				return;
			}

			legendContainer.innerHTML = ''; // Xóa nội dung cũ


			var slices = document.querySelectorAll('.ct-slice-pie'); 
			slices.forEach((slice, index) => {
				var color = window.getComputedStyle(slice).getPropertyValue('fill'); // Lấy màu từ fill của biểu đồ
				var label = dataList[index].MaHP;//labels[index]; // Lấy tên tương ứng

				var legendItem = document.createElement('div');
				legendItem.className = 'legend-item';
				legendItem.innerHTML = `<i class="fa fa-circle" style="color:${color};"></i> ${label}`;



				legendContainer.appendChild(legendItem);

			});
		});

		//--------------------------------------------------


		//BIỂU ĐỒ ĐÔI

		var danhSachHP = _model.DanhSachIdHocPhan;


		if (!Array.isArray(danhSachHP)) {
			danhSachHP = Object.values(dataList); // Chuyển đổi object thành mảng
		}
		console.log(danhSachHP);

		const soluongTrenTBArray = dataList.map(item => item.SoluongTrenTB);
		const soluongDuoiTBArray = dataList.map(item => item.SoluongDuoiTB);
		const mangTongHop = [soluongTrenTBArray, soluongDuoiTBArray];

		console.log("Mảng tổng hợp:", mangTongHop);

		var data = {
		  labels: danhSachHP,
		  series: mangTongHop
		};

		var options = {
			seriesBarDistance: 10,
			axisX: {
				showGrid: false
			},
			height: "245px"
		};

		var responsiveOptions = [
		  ['screen and (max-width: 640px)', {
			seriesBarDistance: 5,
			axisX: {
			  labelInterpolationFnc: function (value) {
				return value[0];
			  }
			}
		  }]
		];

		Chartist.Bar('#chartActivity', data, options, responsiveOptions);

		//----------------------------------------------------------
		//BIỂU ĐỒ ĐƯỜNG
		const mangCacDiem = dataList.map(item => item.DanhSachSoLuongTheoDiem);

		console.log(mangCacDiem);

		const tatCaDiem = mangCacDiem.flat();

	// Tìm giá trị lớn nhất
		const giaTriLonNhat = Math.max(...tatCaDiem);

			const legendDiv = document.getElementById('legend2');
		legendDiv.innerHTML = '';

		// Biến lưu học phần đang chọn
		let currentActiveLegend = null;

		dataList.forEach((item, index) => {
			const legendItem = document.createElement('span');
			legendItem.innerText = item.MaHP;
			legendItem.classList.add('custom-legend-item');
			legendItem.dataset.index = index;

			// Tạo chấm tròn phía trước text
			// const dot = document.createElement('span');
			// dot.classList.add('legend-dot');
			// //dot.style.backgroundColor = getColor(index); // Hàm getColor lấy màu theo index

			// legendItem.prepend(dot);

			legendItem.addEventListener('click', () => {
				const selectedData = {
					labels: ['0 điểm', '1 điểm', '2 điểm', '3 điểm', '4 điểm', '5 điểm', '6 điểm', '7 điểm', '8 điểm', '9 điểm', '10 điểm'],
					series: [item.DanhSachSoLuongTheoDiem]
				};
				const options = {
					lineSmooth: false,
					axisY: {
						offset: 40
					},
					low: 0,
					high: giaTriLonNhat
				};

				Chartist.Line('#chartSales', selectedData, options);

				// Highlight học phần đang chọn
				if (currentActiveLegend) {
					currentActiveLegend.classList.remove('active-legend');
				}
				legendItem.classList.add('active-legend');
				currentActiveLegend = legendItem;
			});

			legendDiv.appendChild(legendItem);
			function getColor(index) {
				const colors = ['#ff6384', '#36a2eb', '#4bc0c0', '#9966ff', '#ff9f40'];
				return colors[index % colors.length];
			}

			// Mặc định chọn phần tử đầu tiên
			if (index === 0) {
				setTimeout(() => legendItem.click(), 0);
			}
		});

		//---------------------------------------------
		//BIỂU ĐỒ CỘT
		var dataDiem = _model.DanhSachDiem;
		if (!Array.isArray(dataList)) {
			dataList = Object.values(dataList); // Chuyển đổi object thành mảng
		}
		var dataViews = {
			labels: danhSachHP,
			series: [dataDiem]
		};


		var optionsViews = {
			seriesBarDistance: 10,
			classNames: {
				bar: 'ct-bar ct-azure'
			},
			axisX: {
				showGrid: false
			},
			axisY: {
				onlyInteger: true, 
				low: 0,            
				high: 10           
			}
		};

		var responsiveOptionsViews = [
			['screen and (max-width: 640px)', {
				seriesBarDistance: 5,
				axisX: {
					labelInterpolationFnc: function (value) {
						return value[0];
					}
				}
			}]
		];

		Chartist.Bar('#chartViews', dataViews, optionsViews, responsiveOptionsViews);

	}

	function redirectToThongke(selectedID) {
		var selectedID = document.getElementById("userselect").value;
		var selectedID2 = document.getElementById("userselect2").value;
		console.log("ID1: " + selectedID);
		console.log("ID2: " + selectedID2);
		if (selectedID && selectedID2) {
			window.location.href = '@Url.Action("Index", "ThongKe")' + '?manganh=' + selectedID + '&masv=' + selectedID2;
		}
		else if (selectedID) {
			window.location.href = '@Url.Action("Index", "ThongKe")' + '?manganh=' + selectedID;
		}
	}
</script>


<style>
	#legend2 {
		display: flex;
		flex-wrap: wrap;
		gap: 15px;
		padding-top: 10px;
	}

	.custom-legend-item {
		cursor: pointer;
		display: flex;
		align-items: center;
		font-size: 14px;
		color: #555;
		padding: 5px 10px;
		border-radius: 20px;
		transition: background-color 0.2s ease;
	}

		.custom-legend-item:hover {
			background-color: #f0f0f0;
		}

		.custom-legend-item.active-legend {
			background-color: #dbeafe;
			color: #1d4ed8;
			font-weight: bold;
		}

	.legend-dot {
		display: inline-block;
		width: 10px;
		height: 10px;
		border-radius: 50%;
		margin-right: 8px;
	}

	.ct-chart .ct-label {
		fill: #fff !important; /* đổi thành trắng */
		font-weight: bold;
		font-size: 14px;
		/*text-shadow: 0 0 2px rgba(0, 0, 0, 0.4); /* giúp chữ nổi hơn */
	}

</style>
